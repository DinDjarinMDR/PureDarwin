name: Build Darwin
on:
  push:
    branches:
      - main
  workflow_dispatch:
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Darwin build environment
        shell: bash
        run: |
          chmod +x ${GITHUB_WORKSPACE}/tools/dbuild/setup.sh
          chmod +x ${GITHUB_WORKSPACE}/tools/dbuild/rc

          source ${GITHUB_WORKSPACE}/tools/dbuild/setup.sh
          export RC_BUILD_JOBS=$(nproc)
          export RC_SYSTEM_ROOT=${GITHUB_WORKSPACE}/output
          export RC_DARWIN_ROOT=${GITHUB_WORKSPACE}
          echo "RC_SYSTEM_ROOT: $RC_SYSTEM_ROOT"
          echo "RC_DARWIN_ROOT: $RC_DARWIN_ROOT"

      - name: Build host toolchain
        shell: bash
        run: |
          ${GITHUB_WORKSPACE}/tools/dbuild/rc --make-host-toolchain

      - name: Build Darwin system
        shell: bash
        run: |
          ${GITHUB_WORKSPACE}/tools/dbuild/rc build

      - name: Upload built system
        uses: actions/upload-artifact@v3
        with:
          name: PureDarwin-system
          path: $RC_SYSTEM_ROOT

      - name: Clean up build artifacts
        if: always()
        shell: bash
        run: |
          ${GITHUB_WORKSPACE}/tools/dbuild/rc clean all
